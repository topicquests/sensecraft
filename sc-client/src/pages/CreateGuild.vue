<template>
  <q-page class="bg-secondary" v-if="ready">
    <div class="row justify-center">
      <q-card style="width: 60%" class="q-mt-md">
        <div>
          <member></member>
        </div>
        <div class="column items-center">
          <div class="col-12 q-mb-md" style="width: 75%">
            <scoreboard></scoreboard>
          </div>
        </div>
        <div class="row justify-center">
          <h4 id="h4" class="q-pa-xs q-ma-xs">Create New Guild</h4>
        </div>
        <div class="column items-center">
          <q-card class="q-pl-md" style="width: 80%">
            <div class="row justify-start q-pa-lg">
              <q-option-group
                v-model="guild.public"
                :options="public_private_bool"
                color="primary"
                inline
              >
              </q-option-group>
            </div>
            <div class="row justify-start q-pb-lg">
              <q-input class="guildText" v-model="guild.name" label="Name" />
            </div>
            <div class="row justify-start q-pb-xs">Details<br /></div>
            <div class="row justify-start q-pb-lg">
              <q-editor
                v-model="guild.description"
                style="width: 85%"
              ></q-editor>
            </div>
            <div class="row">
              <span class="q-pt-md"> Default Role </span>
              <q-select
                class="q-ml-md"
                style="width: 50%"
                v-model="role"
                :options="roleStore.getRoles"
                option-label="name"
                option-value="id"
              />
            </div>
            <div class="row justify-start q-pb-lg">
              <q-input
                v-model="guild.handle"
                label="Handle"
                class="guildText"
              />
            </div>
            <div class="row justify-start q-pb-lg">
              <q-btn
                label="Submit"
                @click="doSubmit(guild)"
                color="primary"
                class="q-mr-md q-ml-md"
              />
              <q-btn label="Cancel" @click="$router.push({ name: 'home' })" />
            </div>
          </q-card>
        </div>
      </q-card>
    </div>
  </q-page>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import scoreboard from '../components/score-board.vue';
import member from '../components/member-handle.vue';
import { userLoaded } from '../boot/userLoaded';
import { public_private_bool } from '../enums';
import { Role } from './../types';
import { onBeforeMount } from 'vue';
import { useRoleStore } from 'src/stores/role';
import { useMembersStore } from 'src/stores/members';
import { useGuildStore } from 'src/stores/guilds';
import { useQuasar } from 'quasar';
import { useRouter } from 'vue-router';

interface guildType {
  name: string,
  handle: string,
  public: boolean,
  description: string,
  default_role_id: number | null | undefined
}

const roleStore = useRoleStore();
const membersStore = useMembersStore();
const guildStore = useGuildStore();
const ready = ref(false)
const $q = useQuasar();
const router = useRouter();
const guild: guildType = {
        name: '',
        handle: '',
        public: false,
        description: '',
        default_role_id: null,
};
const role = ref<Partial<Role>>({name: ''});

async function doSubmit(guild:guildType) {
  try {
    guild.default_role_id = role.value.id;
    const res = await guildStore.createGuild(guild);
    $q.notify({
      message: 'Added new guild',
      color: 'positive',
    });
    router.push({ name: 'guild_admin', params: { guild_id: res.id } });
  } catch (err) {
    console.log('there was an error in creating guild ', err);
    $q.notify({
      message: 'There was an error creating new guild.',
      color: 'negative',
    });
  }
};
onBeforeMount(async () => {
  await userLoaded;
  await roleStore.ensureAllRoles();
  await membersStore.ensureAllMembers();
  ready.value = true;
});
</script>
<style>
.details {
  max-width: 960px;
  min-height: 800px;
  overflow: auto;
  overflow-wrap: normal;
}
.guildText {
  color: blue;
  font-family: Arial, Helvetica, sans-serif;
  width: 25%;
}
#h4 {
  font-family: Arial, Helvetica, sans-serif;
  text-align: center;
}
</style>
